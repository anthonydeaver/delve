/*! Delve 17-04-2014 */
var DelveMap=function(){function a(){this._map=$("#map article div"),this.registerEvents()}return a.prototype.registerEvents=function(){$event.emit("log","registering map events");var a=function(){$("#map").toggle(),$(this).html($("#map").is(":visible")?"Close Map":"Open Map")};$event.bind("togglemap",a),$("#BTN_MAP_TOGGLE").on("click",a)},a.prototype.setStartPoint=function(a){var b=1080,c=1500,d=$("<span />").attr("id",a.id).html(a.name).css("top",c+"px").css("left",b+"px");$(this._map).append(d),this.addExits(c,b,a)},a.prototype.addRoom=function(a,b,c){var d=$("#"+c),e=parseInt($(d).css("left"),10),f=parseInt($(d).css("top"),10);switch(console.log("target: ",f),b){case"north":f-=40;break;case"east":e+=120;break;case"south":f+=40;break;case"west":e-=120}var g=a.name.length>8?this.shorten(a.name):a.name,h=$("<span />").attr("id",a.id).html(g).css("top",f+"px").css("left",e+"px");$(this._map).append(h),this.addExits(f,e,a)},a.prototype.addExits=function(a,b,c){for(var d,e=0;e<c.exits.length;e++){var f=a,g=b,h=$("<span />").addClass("direction "+c.exits[e]).css("border","none");"north"===c.exits[e]&&(f=a-20,d="|"),"south"===c.exits[e]&&(f=a+20,d="|"),h.css("top",f),"west"===c.exits[e]&&(g=b-59,d="&mdash;"),"east"===c.exits[e]&&(g=b+61,d="&mdash;"),h.css("left",g),h.html(d),$(this._map).append(h)}var i=$("#map article").width(),j=$("#map article").height();console.log("scrollLeft: ",b-50-i/2),console.log("scrollTop: ",a-j/2),$("#map article")[0].scrollLeft=b+50-i/2,$("#map article")[0].scrollTop=a-j/2},a.prototype.shorten=function(a){var b=a.split(" "),c=b[0][0]+"."+b[1];return c},a}(),Events=function(){function a(){this._callbacks={}}return a.prototype.bind=function(a,b){this._callbacks[a]||(this._callbacks[a]=[]),this._callbacks[a].push(b)},a.prototype.unbind=function(a,b){for(var c=0;c<this._callbacks[a];c++)if(this._callbacks[a][c]==b)return void this._callbacks[a].splice(c,1)},a.prototype.emit=function(a,b){if(this._callbacks[a])for(var c=0;c<this._callbacks[a].length;c++)this._callbacks[a][c](b)},a}(),Modal=function(){function a(a){this._modalPanel=$("<div>").attr("id","modal").addClass("eventPanel").css("opacity","0"),this.container=$("<div />").addClass("modal"),this.title=$("<h3 />"),this.msg=$("<div />"),this.close=$("<button />").html("Close"),this.closeModal=function(){console.log("closing"),this._modalPanel.animate({opacity:0},200,"linear"),this._modalPanel.remove()},this.button=function(a){var b=function(){console.log("click")};"undefined"!=typeof a.click&&(b=a.click);var c=$("<div>").attr("id","undefined"!=typeof a.id?a.id:"BTN_1234").addClass("button").text("undefined"!=typeof a.label?a.label:"button").click(function(){$(this).data("handler")($(this))}).data("handler",b);if(a.options){var d=a.options;for(var e in d)c.data(e,d[e])}return c};var b=this;$("<div>").addClass("title").appendTo(this._modalPanel),$("<div>").attr("id","message").appendTo(this._modalPanel),$("<div>").attr("id","buttons").appendTo(this._modalPanel);var c,d,e=$(".title",this._modalPanel),f=$("#message",this._modalPanel),g=$("#buttons",this._modalPanel);if(console.log("title: ",e),$("<h2>").text(a.title).appendTo(e),$("<p>").attr("id","banner").html(a.msg).appendTo(f),this._modalPanel.animate({opacity:1},200,"linear"),a.buttons){c=a.buttons;for(d in c)c.hasOwnProperty(d)&&this.button(c[d]).appendTo(g)}else this.button({label:"OK",click:function(){console.log("close"),b.closeModal()}}).appendTo(g);$("body").append(this._modalPanel),this.registerEvents()}return a.prototype.registerEvents=function(){var a=$(".modal");$(".modal button").on("click",function(){$(a).remove()})},a}(),Utils=function(){function a(){this.that="that",this.test="test",this.test2="test2"}return a.shuffle=function(a){for(var b,c,d=a.length;d;b=Math.floor(Math.random()*d),c=a[--d],a[d]=a[b],a[b]=c);return a},a.loadFile=function(){},a.resetForm=function(a){a.find("input:text, input:password, input:file, select, textarea").val(""),a.find("input:radio, input:checkbox").removeAttr("checked").removeAttr("selected")},a.proURIDecoder=function(a){a=a.replace(/\+/g,"%20");for(var b=a.split("%"),c=b[0],d=1;d<b.length;d++)c+=String.fromCharCode(parseInt(b[d].substring(0,2),16))+b[d].substring(2);return c},a}(),Rooms=function(){function a(a){var b=this;this._rooms=[],this._activeRoom=null,this._currentpositionSet=[0,0],this._mapGrid=[],this._gotoRoom=function(a){b.onDirectionSelected(a)},this._onDataDump=function(){b.onDataDump()},this._map=new DelveMap;var c=this;$.getJSON("/environs/"+a+"/rooms.json",function(a){c._deck=a.rooms,c.getStart(),c.registerEvents()})}return a.prototype.onDataDump=function(){var a=this._mapGrid.length;console.log("+++++++++++++++++++++++++++++++++"),console.log("Map Grid:");for(var b=0;a>b;b++)console.log("arr["+b+"]: ",this._mapGrid[b].toString());console.log("+++++++++++++++++++++++++++++++++")},a.prototype.getStart=function(){var a=0,b=0;for(var c in this._deck)this._deck[c].start?(this._activeRoom=this._deck[c],delete this._deck[c]):this._rooms.push(c);if(null===this._activeRoom){var d=this._rooms.pop();this._activeRoom=this._deck[d],delete this._deck[d]}a=this._rooms.length+1,b=Math.floor(a/2),this._mapGrid=this.generateGrid(a),console.log(""),this._mapGrid[b][b]=this._activeRoom.id,this._rooms=Utils.shuffle(this._rooms),this._map.setStartPoint(this._activeRoom),this._activeRoom.position=this._currentpositionSet,this.renderRoom(this._activeRoom)},a.prototype.generateGrid=function(a){for(var b=new Array(a),c=0;a>c;c++)b[c]=new Array(a);return b},a.prototype.getPolar=function(a){var b={north:"south",south:"north",east:"west",west:"east"};return b[a]},a.prototype.onDirectionSelected=function(a){if(console.log("direction: ",a),console.log("active room: ",this._activeRoom[a]),-1===this._activeRoom.exits.indexOf(a))return void $event.emit("nojoy","You can't go that way.");var b;if(this._activeRoom.links[a])this.renderRoom(this._activeRoom.links[a]);else{switch(this._rooms.length||$event.emit("nojoy","That exit is sealed by some unknown force."),b=this.drawRoom(a),b||$event.emit("error","Failed to load new room!"),this._activeRoom.links[a]=b,console.log("links: ",b),b.links[this.getPolar(a)]=this._activeRoom,this._map.addRoom(b,a,this._activeRoom.id),a){case"north":this._currentpositionSet[1]++;break;case"south":this._currentpositionSet[1]--;break;case"east":this._currentpositionSet[0]++;break;case"west":this._currentpositionSet[0]--}b.position=this._currentpositionSet,this.renderRoom(b)}},a.prototype.renderRoom=function(a){$("#exits ul").html(""),$("[data-dir]").each(function(){$(this).removeClass(),$(this).addClass("disabled")}),$("#display header").html(a.name),$("#display #desc").html(a.desc);for(var b=0;b<a.exits.length;b++)$("#exits ul").append($("<li />").html(a.exits[b]));this._activeRoom=a},a.prototype.checkExits=function(a,b){for(var c=this.getPolar(b),d=0;d<a.exits.length;d++)if(a.exits[d]===c)return!0;return!1},a.prototype.rotateRoomExits=function(a){console.log("rotating");for(var b=0;b<a.exits.length;b++)switch(console.log("loop: ",a.exits[b]),a.exits[b]){case"north":a.exits[b]="east";break;case"east":a.exits[b]="south";break;case"south":a.exits[b]="west";break;case"west":a.exits[b]="north"}return a},a.prototype.drawRoom=function(a){function b(a){var b=function(c){return a=e.rotateRoomExits(a),e.checkExits(a,c)||(a=b(c)),a};return b}this._rooms.length||$event.emit("error","no more rooms");var c=this._rooms.pop(),d=this._deck[c];if(this.checkExits(d,a))return d;var e=this,f=b(d);return f(a)},a.prototype.registerEvents=function(){$event.bind("gotoRoom",this._gotoRoom),$event.bind("dump",this._onDataDump)},a}(),Player=function(){function a(){var a=this;this._hp=0,this._gold=0,this._skills=[],this._treasure=[],this._onDumpStats=function(){return a.dumpStats()},this._hp=20,this._gold=5,this._skills=[],this._treasure=[],this.registerEvents()}return a.prototype.getDirection=function(){return this._direction},a.prototype.dumpStats=function(){console.log(">>>>>>>"),console.log("Player stats:"),console.log("HP      : ",this._hp),console.log("GOLD    : ",this._gold),console.log("SKILLS  : ",this._skills),console.log("TREASURE: ",this._treasure),console.log(">>>>>>>")},a.prototype.registerEvents=function(){$event.bind("dump",this._onDumpStats)},a.prototype.move=function(a){this._direction=a},a}(),Engine=function(){function a(a){var b=this;this._mappings={"0001":"haunted_mansion"},this._version="0.0.1",this._onShowHelp=function(a){return b.onShowHelp(a)},this._log=function(a){return b.onLog(a)},this.onLog("this is a test"),this._world=this._mappings[a.world||"0001"],new Player,this._parser=new Parser(this),new Rooms(this._world),this.registerEvents(),this.setupUI()}return a.prototype.registerEvents=function(){var a=this;$event.bind("error",this.throwError),$event.bind("log",this._log),$event.bind("displayHelp",this._onShowHelp),$("#command input").on("keypress",function(b){if(13===b.which){var c=$(this).val();$(this).val(""),a._parser.execute(c)}}),$("#command input").on("focus",function(){$(this).val("")}),$("#temp").on("click",this._onShowHelp),$("#nav header").on("click",function(){var a=$(this).parent();a.animate({right:0===parseInt(a.css("right"),10)?-325:0})})},a.prototype.onLog=function(a){console.log("msg:: ",a);var b=$("feedback").val();console.log("val: ",b),b=b+"\r"+a},a.prototype.onShowHelp=function(){console.log("showing help"),new Modal({title:"Delve Help",msg:"It's simple really, you just enter commands into the command bar (the black bar at the bottom of the screen) and things happen.Currently there are # supported commands:<br /><ul><li><i>GO</i> {direction} - where direction is any of the exits listed for the current room (north, south, etc...)</li><li><i>HELP</i> (obviously)</li><li><i>LOOK</i> - Lets you look at various objects in the room. Might be a good way to.... 'find' things. </li><li><i>LOOK</i> - Lets you look at various objects in the room. Might be a good way to.... 'find' things. </li><li><i>LOOK</i> - Lets you look at various objects in the room. Might be a good way to.... 'find' things. </li><li><i>LOOK</i> - Lets you look at various objects in the room. Might be a good way to.... 'find' things. </li></ul>"})},a.prototype.throwError=function(a){throw a},a.prototype.getRoomManager=function(){return this._roomManager},a.prototype.getFile=function(){},a.prototype.setupUI=function(){$("body").css("background","url(/environs/"+this._world+"/assets/background.jpg) no-repeat"),$("body").css("background-size","cover")},a}(),Parser=function(){function a(a){var b=this;this._commandBuffer=[],this._commands=["go","look","examine","take","use","help"],this.nojoy=["I have no idea what your are asking.","What'chu talking 'bout Willis?","What we have here is, a failure to communicate.","The cake is a lie. "],this.cantDo={go:["You can't go in that direction","That's impossible.","'{%s}'' isn't a valid exit.","Try again, you can't go that way.","Seriously, you have a map..."],look:["Nothing special about the {%s}."]},this._onDataDump=function(){b.onDataDump()},this._engine=a,this.registerEvents()}return a.prototype.declareCantDo=function(a,b){var c=Utils.shuffle(this.cantDo[a]),d=c[0].replace(/{%s}/g,b);this.updateConsole(d)},a.prototype.declareNoJoy=function(){this.nojoy=Utils.shuffle(this.nojoy),this.updateConsole(this.nojoy[0])},a.prototype.updateConsole=function(a){var b=$("#feedback");$(b).append("<br /><span>"+a+"</span>"),$(b)[0].scrollTop=$(b)[0].scrollHeight},a.prototype.handleShowCommand=function(){},a.prototype.handleToggleCommand=function(a){var b=["map","controls","help"],c=a[0];console.log("toggle: ",c),-1===b.indexOf(c)?this.declareNoJoy():$event.emit("toggle"+c,a)},a.prototype.handleGoCommand=function(a,b){var c=["north","south","east","west","up","down"];if(!a.length)return void this.updateConsole("Where would you like to go?");var d=a[0];-1===c.indexOf(d)?this.declareCantDo(b,d):(console.log("going: ",d),$event.emit("gotoRoom",d))},a.prototype.onDataDump=function(){console.log("####################"),console.log("Command Buffer:"),console.log(this._commandBuffer),console.log("####################")},a.prototype.registerEvents=function(){$event.bind("nojoy",this.updateConsole),$event.bind("dump",this._onDataDump)},a.prototype.execute=function(a){$event.emit("log","parsing command"),this._commandBuffer.push(a);var b=a.split(" "),c=b.shift().toLowerCase();switch(c){case"go":this.handleGoCommand(b,c);break;case"help":$event.emit("displayHelp");break;case"show":this.handleShowCommand(b);break;case"toggle":this.handleToggleCommand(b);break;default:this.declareNoJoy()}},a}();