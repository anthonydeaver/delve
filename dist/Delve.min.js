/*! Delve 07-05-2014 */
var DMap=function(){function a(){var a=this;this._level=1,this._onGotoLevel=function(){a.onGotoLevel(a._level+1)},this.onGotoLevel(this._level),this._map=$('#map article[level="1"] div'),this.registerEvents()}return a.prototype.registerEvents=function(){$event.emit("log","registering map events");var a=function(){$("#map").toggle(),$(this).html($("#map").is(":visible")?"Close Map":"Open Map")};$event.bind("togglemap",a),$event.bind("gotoLevel",this._onGotoLevel),$("#BTN_MAP_TOGGLE").on("click",a)},a.prototype.onGotoLevel=function(a){var b=$('#map article[level="'+a+'"] div');if(0==b.length){var c=$("#map"),d=$("<article />").attr("id","wrapper").attr("level",a),e=$("<div />");d.append(e),$(c).append(d),b=$('#map article[level="'+a+'"] div')}this._map=b},a.prototype.addExits=function(a,b,c){for(var d,e=0;e<c.exits.length;e++){var f=a,g=b,h=$("<span />").addClass(c.exits[e]).attr("type","directional");"north"===c.exits[e]&&(f=a-20,d="|"),"south"===c.exits[e]&&(f=a+20,d="|"),h.css("top",f),"west"===c.exits[e]&&(g=b-59,d="&mdash;"),"east"===c.exits[e]&&(g=b+61,d="&mdash;"),h.css("left",g),"down"===c.exits[e]&&(f=a+20,g=b-59,d="/"),"up"===c.exits[e]&&(f=a-20,g=b+61,d="/"),h.css("left",g),h.css("top",f),h.html(d),$(this._map).append(h)}this.centerMap(a,b)},a.prototype.centerMap=function(a,b){$(this._map).css("top",-(a-200)),$(this._map).css("left",-(b-200))},a.prototype.changeLevels=function(a,b){$('#map article[level="'+a+'"]').fadeTo("slow",.1),$('#map article[level="'+b+'"]').fadeIn("slow")},a.prototype.shorten=function(a){var b=a.split(" "),c=b[0][0]+"."+b[1];return c},a.prototype.shiftView=function(a,b){console.log("shifting away from ",b);var c=parseInt($("#"+b).css("left"),10),d=parseInt($("#"+b).css("top"),10);switch(console.log("xPos: ",c),a){case"north":d-=40;break;case"east":c+=120;break;case"south":d+=40;break;case"west":c-=120}this.centerMap(d,c)},a.prototype.addRoom=function(a,b,c){var d,e,f;switch(null===c?(e=1080,f=1500):(d=$("#"+c),e=parseInt($(d).css("left"),10),f=parseInt($(d).css("top"),10)),b){case"north":f-=40;break;case"east":e+=120;break;case"south":f+=40;break;case"west":e-=120}var g=a.name.length>8?this.shorten(a.name):a.name,h=$("<span />").attr("id",a.id).attr("type","room").html(g).css("top",f+"px").css("left",e+"px");$(this._map).append(h),this.addExits(f,e,a)},a}(),Engine=function(){function a(a){var b=this;this._mappings={"0001":"haunted_mansion"},this._onShowHelp=function(a){return b.onShowHelp(a)},this._world=a.world,new Parser,this.loadThemeConfig(this._mappings[a.world])}return Object.defineProperty(a.prototype,"version",{get:function(){return this._version},enumerable:!0,configurable:!0}),a.prototype.registerEvents=function(){$event.bind("error",this.throwError),$event.bind("displayHelp",this._onShowHelp)},a.prototype.onShowHelp=function(){console.log("showing help"),new Modal({title:"Delve Help",msg:"It's simple really, you just enter commands into the command bar (the black bar at the bottom of the screen) and things happen.Currently there are # supported commands:<br /><ul><li><i>GO</i> {direction} - where direction is any of the exits listed for the current room (north, south, etc...)</li><li><i>HELP</i> (obviously)</li><li><i>LOOK</i> - Lets you look at various objects in the room. Might be a good way to.... 'find' things. </li><li><i>LOOK</i> - Lets you look at various objects in the room. Might be a good way to.... 'find' things. </li><li><i>LOOK</i> - Lets you look at various objects in the room. Might be a good way to.... 'find' things. </li><li><i>LOOK</i> - Lets you look at various objects in the room. Might be a good way to.... 'find' things. </li></ul>"})},a.prototype.loadFile=function(a){return new Promise(function(b,c){var d=new XMLHttpRequest;d.open("GET",a),d.onload=function(){200==d.status?b(d.response):c(Error(d.statusText))},d.onerror=function(){c(Error("Network Error"))},d.send()})},a.prototype.loadThemeConfig=function(a){var b=this.loadFile("environs/"+a+"/config.json"),c=this;b.then(function(b){var d=JSON.parse(b);new RoomManager(d),c.injectUI(a)},function(){c.throwError("Failed to load theme config: "+a)})},a.prototype.onDataDump=function(){},a.prototype.throwError=function(a){throw new Error(a)},a.prototype.injectUI=function(a){var b=document.getElementsByTagName("head")[0],c=document.createElement("link");c.setAttribute("rel","stylesheet"),c.type="text/css",c.href="/environs/"+a+"/assets/theme.css",b.insertBefore(c,b.firstChild)},a}(),Events=function(){function a(){this._callbacks={}}return a.prototype.bind=function(a,b){this._callbacks[a]||(this._callbacks[a]=[]),this._callbacks[a].push(b)},a.prototype.unbind=function(a,b){for(var c=0;c<this._callbacks[a];c++)if(this._callbacks[a][c]==b)return void this._callbacks[a].splice(c,1)},a.prototype.emit=function(a,b){if(this._callbacks[a])for(var c=0;c<this._callbacks[a].length;c++)this._callbacks[a][c](b)},a}(),Modal=function(){function a(a){this._modalPanel=$("<div>").attr("id","modal").addClass("eventPanel").css("opacity","0"),this.container=$("<div />").attr("id","content"),this.title=$("<h3 />"),this.msg=$("<div />"),this.close=$("<button />").html("Close"),this.closeModal=function(){console.log("closing"),this._modalPanel.animate({opacity:0},200,"linear"),this._modalPanel.remove()},this.button=function(a){var b=function(){console.log("click")};"undefined"!=typeof a.click&&(b=a.click);var c=$("<div>").attr("id","undefined"!=typeof a.id?a.id:"BTN_1234").addClass("button").text("undefined"!=typeof a.label?a.label:"button").click(function(){$(this).data("handler")($(this))}).data("handler",b);if(a.options){var d=a.options;for(var e in d)c.data(e,d[e])}return c};var b=this;$("<div>").addClass("title").appendTo(this.container),$("<div>").attr("id","message").appendTo(this.container),$("<div>").attr("id","buttons").appendTo(this.container);var c,d,e=$(".title",this.container),f=$("#message",this.container),g=$("#buttons",this.container);if(console.log("title: ",e),$("<h2>").text(a.title).appendTo(e),$("<p>").attr("id","banner").html(a.msg).appendTo(f),this._modalPanel.animate({opacity:1},200,"linear"),a.buttons){c=a.buttons;for(d in c)c.hasOwnProperty(d)&&this.button(c[d]).appendTo(g)}else this.button({label:"OK",click:function(){console.log("close"),b.closeModal()}}).appendTo(g);this._modalPanel.append(this.container),$("body").append(this._modalPanel),this.registerEvents()}return a.prototype.registerEvents=function(){var a=$(".modal");$(".modal button").on("click",function(){$(a).remove()})},a}(),Parser=function(){function a(){var a=this;this._commandBuffer=[],this._commands=["go","look","examine","take","use","help"],this.nojoy=["I have no idea what your are asking.","What'chu talking 'bout Willis?","What we have here is, a failure to communicate.","The cake is a lie. "],this.cantDo={go:["You can't go in that direction","That's impossible.","'{%s}' isn't a valid exit.","Try again, you can't go that way.","Seriously, you have a map..."],look:["Nothing special about the {%s}."]},this._onDataDump=function(){a.onDataDump()},this._execute=function(b){a.execute(b)},this._console=$("#feedback"),console.log("console: ",this._console),this.registerEvents()}return a.prototype.declareCantDo=function(a,b){var c=Utils.shuffle(this.cantDo[a]),d=c[0].replace(/{%s}/g,b);this.updateConsole(d)},a.prototype.declareNoJoy=function(){this.nojoy=Utils.shuffle(this.nojoy),this.updateConsole(this.nojoy[0])},a.prototype.updateConsole=function(a){var b=$("#feedback");b.append("<br /><span>"+a+"</span>"),b[0].scrollTop=b[0].scrollHeight},a.prototype.handleShowCommand=function(){},a.prototype.handleToggleCommand=function(a){var b=["map","controls","help"],c=a[0];-1===b.indexOf(c)?this.declareNoJoy():$event.emit("toggle"+c,a)},a.prototype.handleGoCommand=function(a,b){var c=["north","south","east","west","up","down"];if(!a.length)return void this.updateConsole("Where would you like to go?");var d=a[0];-1===c.indexOf(d)?this.declareCantDo(b,d):$event.emit("gotoRoom",d)},a.prototype.registerEvents=function(){var a=this;$event.bind("nojoy",this.updateConsole),$event.bind("dump",this._onDataDump),$("#command input").on("keypress",function(b){if(13===b.which){var c=$(this).val();$(this).val(""),a._execute(c)}})},a.prototype.onDataDump=function(){console.log("####################"),console.log("Command Buffer:"),console.log(this._commandBuffer),console.log("####################")},a.prototype.execute=function(a){this._commandBuffer.push(a);var b=a.split(" "),c=b.shift().toLowerCase();switch(c){case"go":this.handleGoCommand(b,c);break;case"help":$event.emit("displayHelp");break;case"show":this.handleShowCommand(b);break;case"toggle":this.handleToggleCommand(b);break;default:this.declareNoJoy()}},a}(),Room=function(){function a(a){this._exits=[],this._links={},this._start=!1,this._position={},this._name=a.name,this._id=a.id,this._desc=a.desc,this._exits=a.exits,this._links=a.links,this._hasMonster=a.hasMonster,this._hasItem=a.hasItem,this._start=a.start}return Object.defineProperty(a.prototype,"name",{get:function(){return this._name},enumerable:!0,configurable:!0}),Object.defineProperty(a.prototype,"id",{get:function(){return this._id},enumerable:!0,configurable:!0}),Object.defineProperty(a.prototype,"position",{get:function(){return this._position},set:function(a){this._position=a},enumerable:!0,configurable:!0}),Object.defineProperty(a.prototype,"exits",{get:function(){return this._exits},enumerable:!0,configurable:!0}),Object.defineProperty(a.prototype,"links",{get:function(){return this._links},enumerable:!0,configurable:!0}),Object.defineProperty(a.prototype,"start",{get:function(){return this._start},enumerable:!0,configurable:!0}),a.prototype.hasExit=function(a){for(var b=0;b<this._exits.length;b++)if(this._exits[b]===a)return!0;return!1},a.prototype.render=function(){$('#map span[type="room"]').removeClass("current"),$("#exits ul").html(""),$("[data-dir]").each(function(){$(this).removeClass(),$(this).addClass("disabled")}),$("#display header").html(this._name),$("#display #desc").html(this._desc);for(var a=0;a<this._exits.length;a++){var b=this._exits[a];this._links[b]&&(b+=" <span>("+this._links[b].name+")</span>"),$("#exits ul").append($("<li />").html(b))}$('#map span[type="room"]#'+this._id).addClass("current")},a.prototype.rotateExits=function(){for(var a=0;a<this._exits.length;a++)switch(this._exits[a]){case"north":this._exits[a]="east";break;case"east":this._exits[a]="south";break;case"south":this._exits[a]="west";break;case"west":this._exits[a]="north"}},a}(),RoomManager=function(){function a(a){var b=this;this._deck=[],this._rooms={},this._currentRoom=null,this._startRoom=null,this._gridCoord={x:0,y:0,z:0},this._mapGrid=[],this._shuffle=!0,this._gotoRoom=function(a){b.onDirectionSelected(a)},this._onDataDump=function(){b.onDataDump()},this._map=new DMap,a.shuffle&&(this._shuffle=a.shuffle);var c=a.rooms;for(var d in c)this._rooms[d]=new Room(c[d]);this.setUp(),this.registerEvents()}return a.prototype.onDataDump=function(){var a=this._mapGrid.length;console.log("+++++++++++++++++++++++++++++++++"),console.log("Map Grid:");for(var b=0;a>b;b++)console.log("arr["+b+"]: ",this._mapGrid[b].toString());console.log("current grid coords: ",this._gridCoord),console.log("active room: ",this._currentRoom.id),console.log(">>> Deck:",this._deck.toString()),console.log(">>> Rooms:",this._rooms),console.log("+++++++++++++++++++++++++++++++++")},a.prototype.resetGame=function(){this._currentRoom=null,this._deck=[],this._mapGrid=null;for(var a in this._rooms)this._deck.push(a)},a.prototype.setStartingRoom=function(){for(var a in this._rooms)this._rooms[a].start&&(this._startRoom=this._rooms[a]);null===this._startRoom&&$event.emit("error","Failed to set start room")},a.prototype.initGrid=function(a){var b=0;b=this._deck.length+1,this._gridCoord.x=this._gridCoord.y=b,this._mapGrid=this.generateGrid(2*b),this._mapGrid[b][b]=a.id},a.prototype.setUp=function(){this.setStartingRoom(),this._deck=Object.keys(this._rooms),this._shuffle&&(this._deck=Utils.shuffle(this._deck));var a=this._deck.indexOf(this._startRoom.id);this._deck.splice(a,1),this.initGrid(this._startRoom),this._map.addRoom(this._startRoom,null,null),this._currentRoom=this._startRoom,this._currentRoom.render()},a.prototype.t=function(){},a.prototype.generateGrid=function(a){for(var b=new Array(a),c=0;a>c;c++)b[c]=new Array(a);return console.log("done"),b},a.prototype.getPolar=function(a){var b={north:"south",south:"north",east:"west",west:"east"};return b[a]},a.prototype.onDirectionSelected=function(a){if(console.log(">>>: ",this._currentRoom.exits.indexOf(a)),-1===this._currentRoom.exits.indexOf(a))return void $event.emit("nojoy","You can't go that way.");var b;switch(a){case"north":this._gridCoord.y--;break;case"south":this._gridCoord.y++;break;case"east":this._gridCoord.x++;break;case"west":this._gridCoord.x--}return this._currentRoom.links[a]?(b=this._currentRoom.links[a],this._map.shiftView(a,this._currentRoom.id),this._currentRoom=b,void this._currentRoom.render()):(this._deck.length||$event.emit("nojoy","That exit is sealed by some unknown force."),b=this.selectNewRoom(a),b||$event.emit("error","Failed to load new room!"),this._currentRoom.links[a]=b,b.links[this.getPolar(a)]=this._currentRoom,this._mapGrid[this._gridCoord.y][this._gridCoord.x]=b.id,this.scanGrid(b,a)?(this._map.addRoom(b,a,this._currentRoom.id),this._currentRoom=b,this._currentRoom.render()):console.log("failed to check connections"),void 0)},a.prototype.scanGrid=function(a,b){for(var c=["north","south","east","west"],d=0;d<c.length;d++){var e=c[d],f=this.getPolar(e),g="xxx";if(e!=b){switch(e){case"north":g=this._mapGrid[this._gridCoord.y-1][this._gridCoord.x];break;case"south":g=this._mapGrid[this._gridCoord.y+1][this._gridCoord.x];break;case"east":g=this._mapGrid[this._gridCoord.y][this._gridCoord.x+1];break;case"west":g=this._mapGrid[this._gridCoord.y][this._gridCoord.x-1]}var h=this._rooms[g];if(console.log("iRoom: ",g),h)if(h.hasExit(f))a.hasExit(e)||a.exits.push(f),a.links[e]=h,h.links[f]=a;else{var i=a.exits.indexOf(e);a.exits.splice(i,1)}}}return!0},a.prototype.selectNewRoom=function(a){function b(a){var b=function(c){return a.rotateExits(),a.hasExit(e.getPolar(c))||(a=b(c)),a};return b}console.log("exit: ",a),this._deck.length||$event.emit("error","no more rooms");var c=this._deck.shift(),d=this._rooms[c];if(d.hasExit(this.getPolar(a)))return d;var e=this,f=b(d);return f(a)},a.prototype.init=function(){},a.prototype.registerEvents=function(){$event.bind("gotoRoom",this._gotoRoom),$event.bind("dump",this._onDataDump)},a.prototype.getStartRoom=function(){return this._startRoom},a}(),Utils=function(){function a(){this.that="that",this.test="test",this.test2="test2"}return a.shuffle=function(a){for(var b,c,d=a.length;d;b=Math.floor(Math.random()*d),c=a[--d],a[d]=a[b],a[b]=c);return a},a.loadFile=function(){},a.resetForm=function(a){a.find("input:text, input:password, input:file, select, textarea").val(""),a.find("input:radio, input:checkbox").removeAttr("checked").removeAttr("selected")},a.proURIDecoder=function(a){a=a.replace(/\+/g,"%20");for(var b=a.split("%"),c=b[0],d=1;d<b.length;d++)c+=String.fromCharCode(parseInt(b[d].substring(0,2),16))+b[d].substring(2);return c},a}(),Player=function(){function a(){var a=this;this._hp=0,this._gold=0,this._skills=[],this._treasure=[],this._onDumpStats=function(){return a.dumpStats()},this._hp=20,this._gold=5,this._skills=[],this._treasure=[],this.registerEvents()}return a.prototype.getDirection=function(){return this._direction},a.prototype.dumpStats=function(){console.log(">>>>>>>"),console.log("Player stats:"),console.log("HP      : ",this._hp),console.log("GOLD    : ",this._gold),console.log("SKILLS  : ",this._skills),console.log("TREASURE: ",this._treasure),console.log(">>>>>>>")},a.prototype.registerEvents=function(){$event.bind("dump",this._onDumpStats)},a.prototype.move=function(a){this._direction=a},a}();